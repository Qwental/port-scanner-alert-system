---
- name: Deploy Port Scanner
  hosts: scanners
  become: true

  pre_tasks:
    - name: Check binary exists
      delegate_to: localhost
      become: false
      ansible.builtin.stat:
        path: "../bin/scanner-linux-amd64"
      register: bin_stat

    - name: Fail if not built
      ansible.builtin.fail:
        msg: "Binary not found. Run: make build"
      when: not bin_stat.stat.exists

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install packages
      ansible.builtin.apt:
        name:
          - masscan
          - libpcap-dev
          - sqlite3
        state: present

    - name: Create group
      ansible.builtin.group:
        name: "{{ app_group }}"
        state: present

    - name: Create user
      ansible.builtin.user:
        name: "{{ app_user }}"
        group: "{{ app_group }}"
        home: "{{ app_dir }}"
        shell: /usr/sbin/nologin
        system: true
        create_home: false

    - name: Create directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: "0750"
      loop:
        - "{{ app_dir }}"
        - "{{ app_dir }}/bin"
        - "{{ app_dir }}/config"
        - "{{ app_dir }}/data"

    - name: Copy binary
      ansible.builtin.copy:
        src: "../bin/scanner-linux-amd64"
        dest: "{{ app_dir }}/bin/scanner"
        owner: root
        group: "{{ app_group }}"
        mode: "0750"
      notify: Restart service

    - name: Set cap_net_raw
      community.general.capabilities:
        path: "{{ app_dir }}/bin/scanner"
        capability: cap_net_raw+eip
        state: present
      ignore_errors: true

    - name: Deploy config.yaml
      ansible.builtin.template:
        src: templates/config.yaml.j2
        dest: "{{ app_dir }}/config/config.yaml"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: "0640"
      notify: Restart service

    - name: Deploy .env
      ansible.builtin.template:
        src: templates/scanner.env.j2
        dest: "{{ app_dir }}/config/.env"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: "0600"
      notify: Restart service
      no_log: true

    - name: Deploy systemd unit
      ansible.builtin.template:
        src: templates/scan-service.service.j2
        dest: /etc/systemd/system/{{ app_name }}.service
        mode: "0644"
      notify:
        - Reload systemd
        - Restart service

    - name: Enable and start service
      ansible.builtin.systemd:
        name: "{{ app_name }}"
        enabled: true
        state: started
        daemon_reload: true

    - name: Wait
      ansible.builtin.pause:
        seconds: 3

    - name: Show status
      ansible.builtin.command: systemctl status {{ app_name }} --no-pager
      register: status_out
      changed_when: false
      failed_when: false

    - name: Print status
      ansible.builtin.debug:
        msg: "{{ status_out.stdout_lines }}"

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Restart service
      ansible.builtin.systemd:
        name: "{{ app_name }}"
        state: restarted
